<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©tamorph Optimizer - Cobblemon</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .input-section, .results-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .instructions ul {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .ditto-counter {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: #2c3e50;
        }

        .ditto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }

        .ditto-card {
            background: white;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .ditto-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .ditto-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .iv-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }

        .iv-input {
            display: flex;
            flex-direction: column;
        }

        .iv-input label {
            font-size: 0.8em;
            font-weight: bold;
            color: #7f8c8d;
            margin-bottom: 3px;
        }

        .iv-input input {
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.9em;
            width: 100%;
        }

        .iv-input input:focus {
            outline: none;
            border-color: #3498db;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-optimize {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-optimize:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn-reset {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .optimization-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .results-container {
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }

        .couple-card {
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .couple-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .couple-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .couple-score {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .parents {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .parent {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
        }

        .parent h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .iv-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 0.9em;
        }

        .iv-value {
            text-align: center;
            padding: 5px;
            border-radius: 4px;
            font-weight: bold;
        }

        .iv-31 {
            background: #27ae60;
            color: white;
        }

        .iv-high {
            background: #f39c12;
            color: white;
        }

        .iv-low {
            background: #e74c3c;
            color: white;
        }

        .item-display {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 5px;
            display: inline-block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .couple-info {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .expected-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .expected-stat {
            text-align: center;
            padding: 3px;
            border-radius: 3px;
            font-size: 0.8em;
            background: #e9ecef;
        }

        .footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 20px;
            font-size: 0.9em;
        }

        .selection-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            color: #155724;
        }

        .unused-ditto {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            color: #721c24;
        }

        .unused-ditto h4 {
            margin-bottom: 10px;
            color: #721c24;
        }

        .items-summary {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .items-summary h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .item-assignment {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #bdc3c7;
        }

        .item-assignment h5 {
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¨ M√©tamorph Optimizer</h1>
            <p class="subtitle">Optimise la reproduction de M√©tamorph dans Cobblemon</p>
        </header>

        <div class="main-content">
            <div class="input-section">
                <h2>üìä Entrez vos M√©tamorph</h2>
                
                <div class="instructions">
                    <h3>Comment utiliser :</h3>
                    <ul>
                        <li>Remplissez les IVs (0-31) pour chaque M√©tamorph</li>
                        <li>L'optimiseur s√©lectionnera automatiquement les 30 meilleurs M√©tamorph</li>
                        <li>Il formera 15 couples optimaux avec les objets appropri√©s</li>
                        <li>Maximum 60 M√©tamorph peuvent √™tre saisis</li>
                    </ul>
                </div>

                <div class="ditto-counter">
                    M√©tamorph valides: <span id="validDittosCount">0</span> / 30 maximum utilis√©s
                </div>

                <div class="ditto-grid" id="dittoGrid">
                    <!-- Les cartes M√©tamorph seront g√©n√©r√©es ici par JavaScript -->
                </div>

                <div class="buttons">
                    <button class="btn-optimize" onclick="optimizePairs()">
                        üöÄ Optimiser les couples
                    </button>
                    <button class="btn-reset" onclick="resetAll()">
                        üîÑ Tout r√©initialiser
                    </button>
                </div>
            </div>

            <div class="results-section">
                <h2>üí° R√©sultats d'optimisation</h2>
                <div class="optimization-info" id="optimizationInfo">
                    <div class="info-item">
                        <span class="info-label">M√©tamorph valides:</span>
                        <span id="validDittosCountResult">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Couples form√©s:</span>
                        <span id="couplesCount">0</span>
                    </div>
                </div>
                <div class="results-container" id="resultsContainer">
                    <div class="loading" id="loadingMessage">
                        Cliquez sur "Optimiser les couples" pour voir les r√©sultats...
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>Optimiseur sp√©cial Cobblemon - R√®gles de reproduction adapt√©es aux serveurs publics</p>
        </footer>
    </div>

    <script>
        class CobblemonOptimizer {
            constructor() {
                this.dittos = [];
                this.maxDittos = 60;
                this.maxUsedDittos = 30;
                this.maxPairs = 15;
                this.init();
            }

            init() {
                this.createDittoGrid();
                this.loadFromStorage();
                this.updateDisplay();
            }

            createDittoGrid() {
                const grid = document.getElementById('dittoGrid');
                grid.innerHTML = '';

                for (let i = 0; i < this.maxDittos; i++) {
                    const dittoCard = this.createDittoCard(i);
                    grid.appendChild(dittoCard);
                }
            }

            createDittoCard(index) {
                const card = document.createElement('div');
                card.className = 'ditto-card';
                card.innerHTML = `
                    <h3>M√©tamorph #${index + 1}</h3>
                    <div class="iv-inputs">
                        ${this.createIVInputs(index)}
                    </div>
                `;
                return card;
            }

            createIVInputs(dittoIndex) {
                const stats = ['HP', 'Attaque', 'Defense', 'Attaque Sp√©.', 'Defense Sp√©.', 'Vitesse'];
                return stats.map((stat, statIndex) => `
                    <div class="iv-input">
                        <label>${stat}</label>
                        <input type="number" min="0" max="31" value="0" 
                               data-ditto="${dittoIndex}" data-stat="${statIndex}"
                               onchange="optimizer.updateDitto(${dittoIndex}, ${statIndex}, this.value)"
                               oninput="this.value = Math.max(0, Math.min(31, parseInt(this.value) || 0))">
                    </div>
                `).join('');
            }

            updateDitto(dittoIndex, statIndex, value) {
                if (!this.dittos[dittoIndex]) {
                    this.dittos[dittoIndex] = [0, 0, 0, 0, 0, 0];
                }
                
                const ivValue = Math.max(0, Math.min(31, parseInt(value) || 0));
                this.dittos[dittoIndex][statIndex] = ivValue;
                
                const input = document.querySelector(`input[data-ditto="${dittoIndex}"][data-stat="${statIndex}"]`);
                if (input) input.value = ivValue;
                
                this.saveToStorage();
                this.updateDisplay();
            }

            getAllDittos() {
                const validDittos = [];
                
                for (let i = 0; i < this.dittos.length; i++) {
                    if (this.dittos[i] && this.dittos[i].some(iv => iv > 0)) {
                        validDittos.push({
                            ivs: this.dittos[i],
                            index: i,
                            score: this.calculateIndividualScore(this.dittos[i])
                        });
                    }
                }
                
                return validDittos;
            }

            calculateIndividualScore(ditto) {
                if (!ditto) return 0;
                
                let score = 0;
                for (let i = 0; i < 6; i++) {
                    score += ditto[i] || 0;
                    if (ditto[i] === 31) score += 10;
                }
                return score;
            }

            calculateInheritance(ditto1, ditto2, item1, item2) {
                let inheritedStats = 3;
                let guaranteedStat = -1;
                
                if (item1 === 'destinyknot' || item2 === 'destinyknot') {
                    inheritedStats = 5;
                }
                
                const powerItems = [];
                if (item1 && item1.startsWith('power')) powerItems.push(item1);
                if (item2 && item2.startsWith('power')) powerItems.push(item2);
                
                if (powerItems.length === 1) {
                    guaranteedStat = this.getPowerItemStat(powerItems[0]);
                } else if (powerItems.length === 2) {
                    guaranteedStat = this.getPowerItemStat(Math.random() < 0.5 ? powerItems[0] : powerItems[1]);
                }
                
                return { inheritedStats, guaranteedStat };
            }

            getPowerItemStat(item) {
                const powerMap = {
                    'powerweight': 0,
                    'powerbracer': 1,
                    'powerbelt': 2,
                    'powerlens': 3,
                    'powerband': 4,
                    'poweranklet': 5
                };
                return powerMap[item] || -1;
            }

            calculatePairScore(ditto1, ditto2, item1, item2) {
                const inheritance = this.calculateInheritance(ditto1, ditto2, item1, item2);
                
                let score = 0;
                let perfectStats = 0;
                let expectedIVs = [];
                
                for (let i = 0; i < 6; i++) {
                    let expectedIV;
                    
                    if (i === inheritance.guaranteedStat) {
                        expectedIV = Math.max(ditto1[i] || 0, ditto2[i] || 0);
                    } else if (inheritance.inheritedStats > 0) {
                        const maxIV = Math.max(ditto1[i] || 0, ditto2[i] || 0);
                        const inheritanceChance = inheritance.inheritedStats / (inheritance.guaranteedStat !== -1 ? 5 : 6);
                        const randomIV = 15.5;
                        
                        expectedIV = maxIV * inheritanceChance + randomIV * (1 - inheritanceChance);
                    } else {
                        expectedIV = 15.5;
                    }
                    
                    expectedIVs.push(expectedIV);
                    score += expectedIV;
                    
                    if (expectedIV >= 30) perfectStats++;
                }
                
                // Bonus pour la compl√©mentarit√©
                let complementaryBonus = 0;
                for (let i = 0; i < 6; i++) {
                    if (ditto1[i] === 31 && (ditto2[i] || 0) < 20) complementaryBonus += 8;
                    else if (ditto2[i] === 31 && (ditto1[i] || 0) < 20) complementaryBonus += 8;
                    else if (ditto1[i] === 31 && ditto2[i] === 31) complementaryBonus += 15;
                }
                
                score += complementaryBonus;
                
                return {
                    totalScore: score,
                    perfectStats: perfectStats,
                    expectedIVs: expectedIVs,
                    inheritedStats: inheritance.inheritedStats,
                    guaranteedStat: inheritance.guaranteedStat,
                    items: { item1, item2 }
                };
            }

            findOptimalItems(ditto1, ditto2) {
                const items = [null, 'destinyknot', 'powerweight', 'powerbracer', 'powerbelt', 'powerlens', 'powerband', 'poweranklet'];
                let bestScore = -1;
                let bestItems = { item1: null, item2: null };
                
                for (const item1 of items) {
                    for (const item2 of items) {
                        try {
                            const scoreInfo = this.calculatePairScore(ditto1.ivs, ditto2.ivs, item1, item2);
                            if (scoreInfo.totalScore > bestScore) {
                                bestScore = scoreInfo.totalScore;
                                bestItems = { item1, item2 };
                            }
                        } catch (e) {
                            console.error("Erreur dans calculatePairScore:", e);
                        }
                    }
                }
                
                return bestItems;
            }

            optimizePairs() {
                try {
                    console.log("D√©but de l'optimisation...");
                    
                    const allDittos = this.getAllDittos();
                    const totalDittos = allDittos.length;
                    
                    console.log(`M√©tamorph valides: ${totalDittos}`);
                    
                    if (totalDittos < 2) {
                        this.showResults([], [], totalDittos);
                        alert('‚ùå Veuillez entrer au moins 2 M√©tamorph avec des IVs !');
                        return;
                    }

                    this.showLoading();

                    // Utiliser setTimeout pour permettre √† l'interface de se mettre √† jour
                    setTimeout(() => {
                        try {
                            let selectedDittos = allDittos;
                            if (totalDittos > this.maxUsedDittos) {
                                selectedDittos = allDittos
                                    .sort((a, b) => b.score - a.score)
                                    .slice(0, this.maxUsedDittos);
                            }

                            console.log(`M√©tamorph s√©lectionn√©s: ${selectedDittos.length}`);

                            const usedIndices = new Set(selectedDittos.map(d => d.index));
                            const unusedDittos = allDittos.filter(d => !usedIndices.has(d.index));

                            const pairs = this.findBestPairsWithItems(selectedDittos);
                            console.log(`Couples form√©s: ${pairs.length}`);
                            
                            this.showResults(pairs, unusedDittos, selectedDittos.length);
                        } catch (e) {
                            console.error("Erreur dans l'optimisation:", e);
                            this.showError("Erreur lors de l'optimisation: " + e.message);
                        }
                    }, 100);
                } catch (e) {
                    console.error("Erreur g√©n√©rale:", e);
                    this.showError("Erreur g√©n√©rale: " + e.message);
                }
            }

            findBestPairsWithItems(dittos) {
                const pairs = [];
                const usedIndices = new Set();
                const allPairs = [];
                
                console.log("G√©n√©ration des couples...");
                
                for (let i = 0; i < dittos.length; i++) {
                    for (let j = i + 1; j < dittos.length; j++) {
                        const ditto1 = dittos[i];
                        const ditto2 = dittos[j];
                        
                        const items = this.findOptimalItems(ditto1, ditto2);
                        
                        const scoreInfo = this.calculatePairScore(
                            ditto1.ivs, ditto2.ivs, items.item1, items.item2
                        );
                        
                        allPairs.push({
                            ditto1: { ...ditto1, item: items.item1 },
                            ditto2: { ...ditto2, item: items.item2 },
                            score: scoreInfo.totalScore,
                            perfectStats: scoreInfo.perfectStats,
                            expectedIVs: scoreInfo.expectedIVs,
                            inheritedStats: scoreInfo.inheritedStats,
                            guaranteedStat: scoreInfo.guaranteedStat
                        });
                    }
                }
                
                console.log(`Couples g√©n√©r√©s: ${allPairs.length}`);
                
                allPairs.sort((a, b) => b.score - a.score);
                
                for (const pair of allPairs) {
                    if (pairs.length >= this.maxPairs) break;
                    
                    if (!usedIndices.has(pair.ditto1.index) && !usedIndices.has(pair.ditto2.index)) {
                        pairs.push(pair);
                        usedIndices.add(pair.ditto1.index);
                        usedIndices.add(pair.ditto2.index);
                    }
                }
                
                return pairs;
            }

            showLoading() {
                const container = document.getElementById('resultsContainer');
                container.innerHTML = `
                    <div class="loading">
                        <div>üîç Analyse des M√©tamorph...</div>
                        <div>Calcul des meilleurs couples et objets en cours</div>
                    </div>
                `;
            }

            showError(message) {
                const container = document.getElementById('resultsContainer');
                container.innerHTML = `
                    <div class="error-message">
                        <strong>‚ùå Erreur</strong><br>
                        ${message}
                    </div>
                `;
            }

            showResults(pairs, unusedDittos, usedCount) {
                const container = document.getElementById('resultsContainer');
                const totalDittos = this.getAllDittos().length;
                
                document.getElementById('couplesCount').textContent = pairs.length;
                
                if (pairs.length === 0) {
                    container.innerHTML = `
                        <div class="loading">
                            ‚ùå Aucun couple optimal trouv√©.<br>
                            V√©rifiez que vous avez saisi au moins 2 M√©tamorph avec des IVs.
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                if (totalDittos > this.maxUsedDittos) {
                    html += `
                        <div class="selection-info">
                            <strong>‚ÑπÔ∏è S√©lection automatique</strong><br>
                            Sur ${totalDittos} M√©tamorph valides, les ${usedCount} meilleurs ont √©t√© s√©lectionn√©s pour l'optimisation.
                        </div>
                    `;
                }
                
                html += `<div class="results-summary">
                    <h3>üéØ ${pairs.length} meilleur(s) couple(s) trouv√©(s)</h3>
                </div>`;
                
                pairs.forEach((pair, index) => {
                    html += this.createPairCard(pair, index + 1);
                });

                html += this.createItemsSummary(pairs);
                
                if (unusedDittos.length > 0) {
                    html += `<div class="unused-ditto">
                        <h4>üì¶ M√©tamorph non utilis√©s (${unusedDittos.length})</h4>
                        <p>Ces M√©tamorph n'ont pas √©t√© s√©lectionn√©s pour former des couples :</p>
                        <div style="margin-top: 10px; font-size: 0.9em;">
                            ${unusedDittos.map(d => `M√©tamorph #${d.index + 1}`).join(', ')}
                        </div>
                    </div>`;
                }
                
                container.innerHTML = html;
            }

            createItemsSummary(pairs) {
                const itemNames = {
                    'destinyknot': 'Destiny Knot',
                    'powerweight': 'Poids Pouvoir (HP)',
                    'powerbracer': 'Poignet Pouvoir (Attaque)',
                    'powerbelt': 'Ceinture Pouvoir (D√©fense)',
                    'powerlens': 'Lentille Pouvoir (Attaque Sp√©.)',
                    'powerband': 'Bandeau Pouvoir (D√©fense Sp√©.)',
                    'poweranklet': 'Gu√™tre Pouvoir (Vitesse)',
                    '': 'Aucun'
                };

                const itemUsage = {};
                pairs.forEach(pair => {
                    [pair.ditto1, pair.ditto2].forEach(ditto => {
                        if (ditto.item) {
                            itemUsage[ditto.item] = (itemUsage[ditto.item] || 0) + 1;
                        }
                    });
                });

                let itemsHtml = `<div class="items-summary">
                    <h4>üéÅ Objets recommand√©s</h4>
                    <p>Distribution automatique des objets pour les ${pairs.length * 2} M√©tamorph utilis√©s :</p>
                    <div class="items-grid">`;

                Object.keys(itemUsage).forEach(item => {
                    if (itemUsage[item] > 0) {
                        itemsHtml += `
                            <div class="item-assignment">
                                <h5>${itemNames[item]}</h5>
                                <div>Utilis√©: ${itemUsage[item]} fois</div>
                            </div>
                        `;
                    }
                });

                itemsHtml += `</div></div>`;
                return itemsHtml;
            }

            createPairCard(pair, pairNumber) {
                const itemNames = {
                    'destinyknot': 'Destiny Knot',
                    'powerweight': 'Poids Pouvoir',
                    'powerbracer': 'Poignet Pouvoir',
                    'powerbelt': 'Ceinture Pouvoir',
                    'powerlens': 'Lentille Pouvoir',
                    'powerband': 'Bandeau Pouvoir',
                    'poweranklet': 'Gu√™tre Pouvoir',
                    '': 'Aucun'
                };

                const statNames = ['HP', 'Attaque', 'D√©fense', 'Attaque Sp√©.', 'D√©fense Sp√©.', 'Vitesse'];
                
                const expectedStats = pair.expectedIVs.map((iv, index) => `
                    <div class="expected-stat">
                        ${statNames[index]}: ${iv.toFixed(1)}
                    </div>
                `).join('');

                return `
                    <div class="couple-card">
                        <div class="couple-header">
                            <h3>Couple #${pairNumber}</h3>
                            <div class="couple-score">
                                Score: ${Math.round(pair.score)} | ${pair.perfectStats}/6 excellents
                            </div>
                        </div>
                        <div class="parents">
                            ${this.createParentCard('Parent A', pair.ditto1, pair.guaranteedStat)}
                            ${this.createParentCard('Parent B', pair.ditto2, pair.guaranteedStat)}
                        </div>
                        <div class="couple-info">
                            <div><strong>Objets recommand√©s:</strong></div>
                            <div>
                                <span class="item-display">${itemNames[pair.ditto1.item] || 'Aucun'}</span> + 
                                <span class="item-display">${itemNames[pair.ditto2.item] || 'Aucun'}</span>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.85em;">
                                <strong>H√©ritage:</strong> ${pair.inheritedStats} IVs h√©rit√©s
                                ${pair.guaranteedStat !== -1 ? ` | Stat garantie: ${statNames[pair.guaranteedStat]}` : ''}
                            </div>
                            <div class="expected-stats">
                                ${expectedStats}
                            </div>
                        </div>
                    </div>
                `;
            }

            createParentCard(title, ditto, guaranteedStat) {
                const stats = ['HP', 'Attaque', 'Defense', 'Attaque Sp√©.', 'Defense Sp√©.', 'Vitesse'];
                
                const ivDisplays = ditto.ivs.map((iv, index) => {
                    let className = 'iv-low';
                    if (iv === 31) className = 'iv-31';
                    else if (iv >= 25) className = 'iv-high';
                    
                    const isGuaranteed = index === guaranteedStat;
                    const marker = isGuaranteed ? ' üõ°Ô∏è' : '';
                    
                    return `
                        <div class="iv-value ${className}">
                            ${stats[index]}: ${iv}${marker}
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="parent">
                        <h4>${title} (M√©tamorph #${ditto.index + 1})</h4>
                        <div class="iv-display">
                            ${ivDisplays}
                        </div>
                    </div>
                `;
            }

            resetAll() {
                this.dittos = [];
                this.createDittoGrid();
                this.saveToStorage();
                this.updateDisplay();
                
                const container = document.getElementById('resultsContainer');
                container.innerHTML = `
                    <div class="loading">
                        Cliquez sur "Optimiser les couples" pour voir les r√©sultats...
                    </div>
                `;
            }

            updateDisplay() {
                const validCount = this.getAllDittos().length;
                document.getElementById('validDittosCount').textContent = validCount;
                document.getElementById('validDittosCountResult').textContent = validCount;
            }

            saveToStorage() {
                localStorage.setItem('cobblemonOptimizer_dittos', JSON.stringify(this.dittos));
            }

            loadFromStorage() {
                try {
                    const savedDittos = localStorage.getItem('cobblemonOptimizer_dittos');
                    if (savedDittos) {
                        this.dittos = JSON.parse(savedDittos);
                        
                        for (let i = 0; i < this.dittos.length; i++) {
                            if (this.dittos[i]) {
                                for (let j = 0; j < 6; j++) {
                                    const input = document.querySelector(`input[data-ditto="${i}"][data-stat="${j}"]`);
                                    if (input) input.value = this.dittos[i][j] || 0;
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.error("Erreur lors du chargement:", e);
                }
                
                this.updateDisplay();
            }
        }

        // Initialiser l'optimiseur
        const optimizer = new CobblemonOptimizer();

        // Fonctions globales
        function optimizePairs() {
            optimizer.optimizePairs();
        }

        function resetAll() {
            optimizer.resetAll();
        }
    </script>
</body>
</html>
